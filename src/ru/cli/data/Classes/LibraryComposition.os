Перем СоответствиеКомандМодулей;
Перем Версия;
Перем КэшированиеИндексов;
Перем ТекущийКаталог;
Перем КаталогПакетов;


Процедура ПриСозданииОбъекта()
    
    ТекущийКаталог = ТекущийСценарий().Каталог;
    ИнициализироватьОсновныеСписки();  
    
КонецПроцедуры

Процедура ИнициализироватьОсновныеСписки() Экспорт
    
    ФайлДанных = ОбъединитьПути(ТекущийКаталог, "index", "lib.json");  
    Данные     = ПрочитатьJSONФайл(ФайлДанных);
    
    КэшированиеИндексов       = Новый Соответствие();
    СоответствиеКомандМодулей = Данные["modules"];
    Версия                    = Данные["version"];
    
КонецПроцедуры

Функция ПолучитьВерсию() Экспорт
    Возврат Версия;
КонецФункции

Функция ПолучитьСоответствиеКомандМодулей() Экспорт
    Возврат СоответствиеКомандМодулей;
КонецФункции

Функция ПолучитьИнформациюИндекса(Знач Команда) Экспорт
    
    ИнформацияИндекса = КэшированиеИндексов.Получить(Команда);
    
    Если ИнформацияИндекса = Неопределено Тогда
        
        Попытка

            ПутьИндекса  = ОбъединитьПути(ТекущийКаталог, "index", Команда + ".json");
            ДанныеМодуля = ПрочитатьJSONФайл(ПутьИндекса);        
            
            КэшированиеИндексов.Вставить(Команда, ДанныеМодуля);
            
        Исключение
            ВызватьИсключение СтрШаблон("Некорректное имя команды: %1", Команда)
        КонецПопытки;
        
    КонецЕсли;
    
    Возврат ДанныеМодуля;
    
КонецФункции

Функция ПолучитьПолныйСостав() Экспорт
    
    Для Каждого Команда Из СоответствиеКомандМодулей Цикл
        ПолучитьИнформациюИндекса(Команда.Ключ);
    КонецЦикла;
    
    Возврат КэшированиеИндексов;
    
КонецФункции

Функция СформироватьСтрокуВызоваМетода(Знач ПереданныеПараметры, Знач Команда, Знач Метод) Экспорт
    
    Если КаталогПакетов = Неопределено Тогда
        ОпределитьКаталогПакетов();
    КонецЕсли;
    
    Модуль             = СоответствиеКомандМодулей.Получить(Команда);
    ОбъектИндекса      = ПолучитьИнформациюИндекса(Команда);
    ПараметрыМетода    = Неопределено;
    
    Если Не ЗначениеЗаполнено(Модуль) Тогда
        Возврат Новый Структура("Ошибка,Результат", Истина, "Команда");
    КонецЕсли;
    
    Для Каждого Метод Из ОбъектИндекса["methods"] Цикл
        Если Метод["id"] = вРег(Метод) Тогда
            ПараметрыМетода = Метод["params"];
            Прервать;
        КонецЕсли;
    КонецЦикла;

    Если ПараметрыМетода = Неопределено Тогда
        Возврат Новый Структура("Ошибка,Результат", Истина, "Метод");
    КонецЕсли;
    
    ТекстВыполнения = "";
    СтрокаВызова    = Модуль + "." + Метод + "(";
    Счетчик         = 0;
    
    Для Каждого НеобходимыйПараметр Из ПараметрыМетода Цикл
        
        ИмяПараметра      = НеобходимыйПараметр["name"];
        ИмяПараметраСокр  = НеобходимыйПараметр["short"];
        
        ЗначениеПараметра = ПереданныеПараметры.Получить(ИмяПараметра);
        ЗначениеПараметра = ?(ЗначениеПараметра = Неопределено
            , ПереданныеПараметры.Получить(ИмяПараметраСокр)
            , ЗначениеПараметра);
        
        Если ЗначениеЗаполнено(ЗначениеПараметра) Тогда
            
            ИмяПараметра = "Параметр" + СтрЗаменить(ИмяПараметра, "--", "_");
            
            ТекстВыполнения = ТекстВыполнения 
            + Символы.ПС 
            + ИмяПараметра
            + " = """ 
            + СтрЗаменить(ЗначениеПараметра, """", """""")
            + """;";
            
            Если ТребуетсяОбработкаУправляющихПоследовательностей(ИмяПараметра, ЗначениеПараметра) Тогда
                ТекстВыполнения = ТекстВыполнения 
                + Символы.ПС 
                + "OPI_Инструменты.ЗаменитьУправляющиеПоследовательности(" + ИмяПараметра + ");";
            КонецЕсли;
            
            СтрокаВызова = СтрокаВызова + ИмяПараметра + ", ";
            Счетчик      = Счетчик + 1;
            
        Иначе
            СтрокаВызова = СтрокаВызова + " , ";
        КонецЕсли;
        
    КонецЦикла;
    
    ЛишниеСимволы   = 2;
    СтрокаВызова    = Лев(СтрокаВызова, СтрДлина(СтрокаВызова) - ЛишниеСимволы);
    СтрокаВызова    = СтрокаВызова + ");";
    СтрокаВызова    = "Ответ = " + СтрокаВызова;
    ТекстВыполнения = ТекстВыполнения + Символы.ПС + СтрокаВызова;
    
    СтруктураВозврата = Новый Структура("Ошибка,Результат", Ложь, ТекстВыполнения);
    
    Возврат СтруктураВозврата;
    
КонецФункции

Процедура ДополнитьКэшСостава(Знач Библиотека, Знач ТаблицаПараметров, Команда = "") Экспорт
    
    Команда           = ?(ЗначениеЗаполнено(Команда), Команда, Библиотека);
    СтрокаПодключения = "";
    
    ИнформацияИндекса = Новый Структура;
    ИнформацияИндекса.Вставить("Состав"           , ТаблицаПараметров);
    ИнформацияИндекса.Вставить("СтрокаПодключения", СтрокаПодключения);
    
    КэшированиеИндексов.Вставить(Команда, ИнформацияИндекса);
    СоответствиеКомандМодулей.Вставить(Команда, Библиотека);
    
КонецПроцедуры

Процедура УстановитьКаталогПакетов(Знач Путь) Экспорт
    КаталогПакетов = Путь;
КонецПроцедуры

Процедура ОпределитьКаталогПакетов()
    
    ТекущийКаталог = ТекущийСценарий().Каталог;
    ТекущийКаталог = СтрЗаменить(ТекущийКаталог, "\", "/");
    
    ЧастиПути      = СтрРазделить(ТекущийКаталог, "/");
    ЧастиПути.Удалить(ЧастиПути.ВГраница());
    ЧастиПути.Удалить(ЧастиПути.ВГраница());
    ЧастиПути.Удалить(ЧастиПути.ВГраница());
    
    КаталогПакетов = СтрСоединить(ЧастиПути, "/");
    
КонецПроцедуры

Функция ТребуетсяОбработкаУправляющихПоследовательностей(Знач ИмяПараметра, Знач ЗначениеПараметра)
    
    ФайлПараметра         = Новый Файл(ЗначениеПараметра);
    ЗначениеПараметраСокр = СокрЛП(ЗначениеПараметра);
    
    Возврат Не СтрНачинаетсяС(ЗначениеПараметраСокр, "{")
    И Не СтрНачинаетсяС(ЗначениеПараметраСокр, "[") 
    И Не ФайлПараметра.Существует() 
    И Не ИмяПараметра = "Параметр_out";
    
КонецФункции

Функция ПрочитатьJSONФайл(Знач Путь)
    
    ЧтениеJSON = Новый ЧтениеJSON();
    ЧтениеJSON.ОткрытьФайл(Путь);
    Данные = ПрочитатьJSON(ЧтениеJSON, Истина);
    ЧтениеJSON.Закрыть();

    Возврат Данные;

КонецФункции
#Region Alternate

Procedure InitializeCommonLists() Export
	ИнициализироватьОсновныеСписки();
EndProcedure

Function GetVersion() Export
	Return ПолучитьВерсию();
EndFunction

Function GetCommandModuleMapping() Export
	Return ПолучитьСоответствиеКомандМодулей();
EndFunction

Function GetIndexData(Val Command) Export
	Return ПолучитьИнформациюИндекса(Command);
EndFunction

Function GetFullComposition() Export
	Return ПолучитьПолныйСостав();
EndFunction

Function FormMethodCallString(Val PassedParameters, Val Command, Val Method) Export
	Return СформироватьСтрокуВызоваМетода(PassedParameters, Command, Method);
EndFunction

Procedure CompleteCompositionCache(Val Library, Val ParametersTable, Command = "") Export
	ДополнитьКэшСостава(Library, ParametersTable, Command);
EndProcedure

Procedure SetPackagesDirectory(Val Path) Export
	УстановитьКаталогПакетов(Path);
EndProcedure

#EndRegion